<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Referrals | Cryptware Partner Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script type="module" src="./js/config.js"></script>
    <script type="module" src="./js/utils/toast.js"></script>
    <style>
        :root {
            --primary-blue: #2563eb;
            --primary-dark: #1e40af;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .trust-badge {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-dark));
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .status-code_sent { background: #fef3c7; color: #d97706; }
        .status-contacted { background: #dbeafe; color: #1e40af; }
        .status-meeting_scheduled { background: #e0e7ff; color: #3730a3; }
        .status-proposal_sent { background: #f3e8ff; color: #7c3aed; }
        .status-negotiation { background: #fef3c7; color: #d97706; }
        .status-won { background: #d1fae5; color: #065f46; }
        .status-fully_paid { background: #dcfce7; color: #166534; }
        .status-lost { background: #fee2e2; color: #dc2626; }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .filter-btn {
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: #2563eb;
            color: white;
        }

        .referral-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .referral-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15);
        }

        .referral-card.code_sent { border-left-color: #d97706; }
        .referral-card.contacted { border-left-color: #1e40af; }
        .referral-card.meeting_scheduled { border-left-color: #3730a3; }
        .referral-card.proposal_sent { border-left-color: #7c3aed; }
        .referral-card.negotiation { border-left-color: #d97706; }
        .referral-card.won { border-left-color: #065f46; }
        .referral-card.fully_paid { border-left-color: #166534; }
        .referral-card.lost { border-left-color: #dc2626; }

        .mobile-menu {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .mobile-menu.open {
            transform: translateX(0);
        }

        @media (max-width: 768px) {
            .mobile-stack {
                flex-direction: column;
            }
            .mobile-full {
                width: 100%;
            }
            .mobile-text-center {
                text-align: center;
            }
            .mobile-hide {
                display: none;
            }
            .mobile-show {
                display: block;
            }
            .table-header {
                font-size: 0.75rem;
            }
        }

        @media (min-width: 769px) {
            .mobile-show {
                display: none;
            }
        }

        .pagination-btn {
            transition: all 0.3s ease;
        }

        .pagination-btn:hover:not(.disabled) {
            background: #2563eb;
            color: white;
        }

        .pagination-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-blue-100 min-h-screen font-['Inter']">
    <!-- Navigation Header -->
    <nav class="bg-white border-b shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <a href="partner-dashboard.html" class="flex items-center text-blue-600 hover:text-blue-700 font-semibold mobile-hide">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Dashboard
                    </a>
                    <div class="trust-badge p-2 rounded-lg">
                        <i class="fas fa-handshake text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">My Referrals</h1>
                        <p class="text-xs text-gray-500">Track and manage your referrals</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600 mobile-hide" id="partnerCompanyName"></span>
                    <button onclick="openMobileMenu()" class="mobile-show bg-blue-50 text-blue-600 p-2 rounded-lg md:hidden">
                        <i class="fas fa-bars"></i>
                    </button>
                    <button onclick="AuthManager.logout()" class="bg-blue-50 text-blue-600 px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-100 transition flex items-center mobile-hide">
                        <i class="fas fa-sign-out-alt mr-2"></i>Sign Out
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="mobile-menu fixed inset-0 bg-white z-50 md:hidden">
        <div class="p-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold text-gray-900">Menu</h2>
                <button onclick="closeMobileMenu()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="space-y-4">
                <a href="partner-dashboard.html" class="block py-3 px-4 bg-blue-50 text-blue-600 rounded-lg font-semibold">
                    <i class="fas fa-chart-bar mr-3"></i>Dashboard
                </a>
                <a href="referrals.html" class="block py-3 px-4 bg-blue-600 text-white rounded-lg font-semibold">
                    <i class="fas fa-handshake mr-3"></i>My Referrals
                </a>
                <a href="generate-referral.html" class="block py-3 px-4 bg-gray-100 text-gray-700 rounded-lg font-semibold">
                    <i class="fas fa-plus mr-3"></i>Create Referral
                </a>
                <a href="commission-report.html" class="block py-3 px-4 bg-gray-100 text-gray-700 rounded-lg font-semibold">
                    <i class="fas fa-chart-pie mr-3"></i>Commissions
                </a>
                <div class="pt-4 border-t">
                    <p class="text-sm text-gray-600 mb-2" id="mobilePartnerName"></p>
                    <button onclick="AuthManager.logout()" class="w-full bg-red-50 text-red-600 py-3 px-4 rounded-lg font-semibold flex items-center justify-center">
                        <i class="fas fa-sign-out-alt mr-2"></i>Sign Out
                    </button>
                </div>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Quick Stats Bar -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="glass-card rounded-xl p-4 text-center">
                <div class="text-2xl font-bold text-blue-600" id="totalReferrals">0</div>
                <p class="text-sm text-gray-600">Total Referrals</p>
            </div>
            <div class="glass-card rounded-xl p-4 text-center">
                <div class="text-2xl font-bold text-green-600" id="activeReferrals">0</div>
                <p class="text-sm text-gray-600">Active</p>
            </div>
            <div class="glass-card rounded-xl p-4 text-center">
                <div class="text-2xl font-bold text-purple-600" id="convertedReferrals">0</div>
                <p class="text-sm text-gray-600">Converted</p>
            </div>
            <div class="glass-card rounded-xl p-4 text-center">
                <div class="text-2xl font-bold text-yellow-600" id="totalCommission">₦0</div>
                <p class="text-sm text-gray-600">Total Commission</p>
            </div>
        </div>

        <!-- Action Bar -->
        <div class="glass-card rounded-2xl p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0">
                <div class="flex-1">
                    <h2 class="text-lg font-semibold text-gray-900 mb-2">Referral Management</h2>
                    <p class="text-gray-600 text-sm">Create and track your referral progress</p>
                </div>
                <div class="flex space-x-3 w-full md:w-auto">
                    <a href="generate-referral.html" class="flex-1 md:flex-none trust-badge text-white px-6 py-3 rounded-lg font-semibold text-center flex items-center justify-center">
                        <i class="fas fa-plus-circle mr-2"></i>Create Referral
                    </a>
                    <!-- <button onclick="exportReferrals()" class="flex-1 md:flex-none bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg font-semibold flex items-center justify-center">
                        <i class="fas fa-download mr-2"></i>Export
                    </button> -->
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="glass-card rounded-2xl p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0">
                <!-- Status Filters -->
                <div class="flex flex-wrap gap-2">
                    <button onclick="setFilter('all')" class="filter-btn active bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                        All
                    </button>
                    <button onclick="setFilter('code_sent')" class="filter-btn bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium">
                        Code Sent
                    </button>
                    <button onclick="setFilter('contacted')" class="filter-btn bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium">
                        Contacted
                    </button>
                    <button onclick="setFilter('won')" class="filter-btn bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium">
                        Won
                    </button>
                    <button onclick="setFilter('fully_paid')" class="filter-btn bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium">
                        Fully Paid
                    </button>
                </div>

                <!-- Search Box -->
                <div class="relative w-full md:w-64">
                    <input type="text" id="searchInput" placeholder="Search referrals..." 
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12 fade-in">
            <div class="loading-spinner text-blue-600 text-4xl mb-4">
                <i class="fas fa-spinner"></i>
            </div>
            <p class="text-gray-600">Loading your referrals...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden text-center py-12">
            <div class="text-red-500 text-4xl mb-4">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Failed to Load Referrals</h3>
            <p class="text-gray-600 mb-4" id="errorMessage"></p>
            <button onclick="loadReferrals()" class="trust-badge text-white px-4 py-2 rounded-lg font-semibold">
                <i class="fas fa-redo mr-2"></i>Try Again
            </button>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-12">
            <div class="text-blue-200 text-6xl mb-4">
                <i class="fas fa-handshake"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">No Referrals Yet</h3>
            <p class="text-gray-600 mb-6">Start by creating your first referral to track progress and earn commissions.</p>
            <a href="generate-referral.html" class="trust-badge inline-flex items-center px-6 py-3 text-white text-lg font-semibold rounded-lg">
                <i class="fas fa-plus-circle mr-2"></i>Create Your First Referral
            </a>
        </div>

        <!-- Referrals Content -->
        <div id="referralsContent" class="hidden fade-in">
            <!-- Mobile Cards View -->
            <div id="mobileView" class="space-y-4 md:hidden">
                <!-- Mobile cards will be populated here -->
            </div>

            <!-- Desktop Table View -->
            <div id="desktopView" class="hidden md:block">
                <div class="glass-card rounded-2xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-blue-600 uppercase tracking-wider table-header">
                                        Company & Contact
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-blue-600 uppercase tracking-wider table-header mobile-hide">
                                        Referral Code
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-blue-600 uppercase tracking-wider table-header">
                                        Status
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-blue-600 uppercase tracking-wider table-header mobile-hide">
                                        Commission
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-blue-600 uppercase tracking-wider table-header">
                                        Created
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-blue-600 uppercase tracking-wider table-header">
                                        Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100" id="referralsTableBody">
                                <!-- Table rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            <div id="pagination" class="flex justify-between items-center mt-6">
                <div class="text-sm text-gray-600" id="paginationInfo">
                    Showing 0 of 0 referrals
                </div>
                <div class="flex space-x-2">
                    <button onclick="previousPage()" id="prevPageBtn" class="pagination-btn bg-white border border-gray-300 px-4 py-2 rounded-lg text-sm font-medium disabled">
                        <i class="fas fa-chevron-left mr-1"></i> Previous
                    </button>
                    <button onclick="nextPage()" id="nextPageBtn" class="pagination-btn bg-white border border-gray-300 px-4 py-2 rounded-lg text-sm font-medium disabled">
                        Next <i class="fas fa-chevron-right ml-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
            <div class="flex items-center mb-4">
                <div class="bg-red-100 p-3 rounded-full mr-4">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Delete Referral</h3>
                    <p class="text-gray-600">Are you sure you want to delete this referral?</p>
                </div>
            </div>
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                <p class="text-sm text-red-700" id="deleteReferralInfo"></p>
            </div>
            <div class="flex justify-end space-x-3">
                <button onclick="closeDeleteModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium">
                    Cancel
                </button>
                <button onclick="confirmDelete()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold">
                    <i class="fas fa-trash mr-2"></i>Delete Referral
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentReferrals = [];
        let currentPage = 1;
        let totalPages = 1;
        let currentLimit = 10;
        let currentFilter = 'all';
        let currentSearch = '';
        let referralToDelete = null;
        let refreshInterval = null; 

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            const currentPartner = JSON.parse(localStorage.getItem('currentPartner'));
            if (!currentPartner) {
                Toast.error('Please log in to view referrals');
                setTimeout(() => window.location.href = 'login.html', 1500);
                return;
            }

            document.getElementById('partnerCompanyName').textContent = currentPartner.company_name;
            document.getElementById('mobilePartnerName').textContent = currentPartner.company_name;

            loadReferrals();
            setupEventListeners();
        });
        // Setup event listeners
        function setupEventListeners() {
            // Search input with debounce
            let searchTimeout;
            document.getElementById('searchInput').addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentSearch = e.target.value;
                    currentPage = 1;
                    loadReferrals();
                }, 500);
            });

        }

        // Load referrals from backend
        async function loadReferrals() {
            try {
                showLoading();
                
                const params = new URLSearchParams({
                    page: currentPage,
                    limit: currentLimit
                });

                if (currentFilter !== 'all') {
                    params.append('status', currentFilter);
                }

                if (currentSearch) {
                    params.append('search', currentSearch);
                }

                const response = await apiClient.get(`/referrals?${params}`);
                
                if (response.data.success) {
                    currentReferrals = response.data.data.referrals || [];
                    totalPages = response.data.data.pagination?.pages || 1;
                    
                    updateStats(response.data.data.statistics);
                    displayReferrals();
                    updatePagination(response.data.data.pagination);
                    
                    if (currentReferrals.length === 0) {
                        showEmptyState();
                    } else {
                        showContent();
                    }
                } else {
                    throw new Error(response.data.message || 'Failed to load referrals');
                }
            } catch (error) {
                console.error('Error loading referrals:', error);
                showError(error.response?.data?.message || error.message || 'Failed to load referrals');
            }
        }

        // Update statistics
        function updateStats(statistics) {
            if (!statistics) return;

            document.getElementById('totalReferrals').textContent = statistics.total || 0;
            document.getElementById('activeReferrals').textContent = 
                (statistics.code_sent || 0) + (statistics.contacted || 0) + 
                (statistics.meeting_scheduled || 0) + (statistics.proposal_sent || 0) + 
                (statistics.negotiation || 0);
            document.getElementById('convertedReferrals').textContent = 
                (statistics.won || 0) + (statistics.fully_paid || 0);
            
            // Calculate total commission from all referrals
            let totalCommission = 0;
            currentReferrals.forEach(ref => {
                totalCommission += ref.total_commission_earned || 0;
            });
            document.getElementById('totalCommission').textContent = formatCurrency(totalCommission);
        }

        // Display referrals in both mobile and desktop views
        function displayReferrals() {
            displayDesktopView();
            displayMobileView();
        }

        // Display desktop table view
        function displayDesktopView() {
            const tableBody = document.getElementById('referralsTableBody');
            
            if (currentReferrals.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-3 opacity-50"></i>
                            <p>No referrals found</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = currentReferrals.map(referral => `
                <tr class="referral-card ${referral.status} hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-building text-blue-600"></i>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-semibold text-gray-900">${referral.prospect_company_name}</div>
                                <div class="text-sm text-gray-500">${referral.contact_name}</div>
                                <div class="text-xs text-gray-400 mobile-show">${referral.referral_code}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900 mobile-hide">
                        <code class="bg-gray-100 px-2 py-1 rounded text-xs font-mono">${referral.referral_code}</code>
                    </td>
                    <td class="px-6 py-4">
                        <span class="status-badge status-${referral.status}">${formatStatus(referral.status)}</span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900 mobile-hide">
                        <div class="font-semibold text-green-600">${formatCurrency(referral.total_commission_earned || 0)}</div>
                        <div class="text-xs text-gray-500">${formatCurrency(referral.total_deal_value || 0)} total</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                        ${new Date(referral.created_at).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 text-sm font-medium">
                        <div class="flex space-x-2">
                            <button onclick="viewReferral('${referral.id}')" class="text-blue-600 hover:text-blue-900" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editReferral('${referral.id}')" class="text-green-600 hover:text-green-900" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteReferral('${referral.id}', '${referral.prospect_company_name}')" class="text-red-600 hover:text-red-900" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Display mobile cards view
        function displayMobileView() {
            const mobileView = document.getElementById('mobileView');
            
            if (currentReferrals.length === 0) {
                mobileView.innerHTML = '';
                return;
            }

            mobileView.innerHTML = currentReferrals.map(referral => `
                <div class="referral-card ${referral.status} glass-card rounded-xl p-4">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900 text-sm">${referral.prospect_company_name}</h3>
                            <p class="text-gray-600 text-xs">${referral.contact_name}</p>
                        </div>
                        <span class="status-badge status-${referral.status} text-xs">${formatStatus(referral.status)}</span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-xs mb-3">
                        <div>
                            <span class="text-gray-500">Code:</span>
                            <div class="font-mono font-semibold">${referral.referral_code}</div>
                        </div>
                        <div>
                            <span class="text-gray-500">Commission:</span>
                            <div class="font-semibold text-green-600">${formatCurrency(referral.total_commission_earned || 0)}</div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center text-xs text-gray-500 mb-3">
                        <span>Created: ${new Date(referral.created_at).toLocaleDateString()}</span>
                        <span>Value: ${formatCurrency(referral.total_deal_value || 0)}</span>
                    </div>

                    <div class="flex justify-between space-x-2">
                        <button onclick="viewReferral('${referral.id}')" class="flex-1 bg-blue-600 text-white py-2 px-3 rounded-lg text-xs font-semibold flex items-center justify-center">
                            <i class="fas fa-eye mr-1"></i> View
                        </button>
                        <button onclick="editReferral('${referral.id}')" class="flex-1 bg-green-600 text-white py-2 px-3 rounded-lg text-xs font-semibold flex items-center justify-center">
                            <i class="fas fa-edit mr-1"></i> Edit
                        </button>
                        <button onclick="deleteReferral('${referral.id}', '${referral.prospect_company_name}')" class="flex-1 bg-red-600 text-white py-2 px-3 rounded-lg text-xs font-semibold flex items-center justify-center">
                            <i class="fas fa-trash mr-1"></i> Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Format status for display
        function formatStatus(status) {
            const statusMap = {
                'code_sent': 'Code Sent',
                'contacted': 'Contacted',
                'meeting_scheduled': 'Meeting Scheduled',
                'proposal_sent': 'Proposal Sent',
                'negotiation': 'In Negotiation',
                'won': 'Won',
                'fully_paid': 'Fully Paid',
                'lost': 'Lost'
            };
            return statusMap[status] || status;
        }

        // Format currency
        function formatCurrency(amount) {
            return '₦' + (amount || 0).toLocaleString();
        }

        // Set filter and reload
        function setFilter(status) {
            currentFilter = status;
            currentPage = 1;
            
            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            });
            
            event.target.classList.add('active', 'bg-blue-600', 'text-white');
            event.target.classList.remove('bg-gray-100', 'text-gray-700');
            
            loadReferrals();
        }

        // Pagination functions
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                loadReferrals();
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                loadReferrals();
            }
        }

        function updatePagination(pagination) {
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const info = document.getElementById('paginationInfo');

            if (!pagination) return;

            const start = ((currentPage - 1) * currentLimit) + 1;
            const end = Math.min(currentPage * currentLimit, pagination.total);
            
            info.textContent = `Showing ${start}-${end} of ${pagination.total} referrals`;

            prevBtn.disabled = currentPage <= 1;
            prevBtn.classList.toggle('disabled', currentPage <= 1);
            
            nextBtn.disabled = currentPage >= totalPages;
            nextBtn.classList.toggle('disabled', currentPage >= totalPages);
        }

        // Action functions
        function viewReferral(referralId) {
            window.location.href = `referral-details.html?id=${referralId}`;
        }

        function editReferral(referralId) {
            // For now, redirect to details page where edit is available
            window.location.href = `referral-details.html?id=${referralId}`;
        }

        function deleteReferral(referralId, companyName) {
            referralToDelete = referralId;
            document.getElementById('deleteReferralInfo').textContent = 
                `This will permanently delete the referral for ${companyName}. This action cannot be undone.`;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            referralToDelete = null;
        }

        async function confirmDelete() {
            if (!referralToDelete) return;

            try {
                // Here you would make an API call to delete the referral
                // For now, we'll simulate deletion
                
                Toast.success('Referral deleted successfully!');
                closeDeleteModal();
                loadReferrals(); // Refresh the list
                
            } catch (error) {
                console.error('Error deleting referral:', error);
                Toast.error('Failed to delete referral');
            }
        }

        function exportReferrals() {
            Toast.info('Export feature coming soon!');
            // Implement CSV/Excel export functionality
        }

        // Mobile menu functions
        function openMobileMenu() {
            document.getElementById('mobileMenu').classList.add('open');
        }

        function closeMobileMenu() {
            document.getElementById('mobileMenu').classList.remove('open');
        }

        // UI State Management
        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('referralsContent').classList.add('hidden');
        }

        function showContent() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('referralsContent').classList.remove('hidden');
        }

        function showEmptyState() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('referralsContent').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
        }

        function showError(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('referralsContent').classList.add('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        // Make functions globally available
        window.AuthManager = {
            logout: function() {
                localStorage.removeItem('currentPartner');
                localStorage.removeItem('authToken');
                window.location.href = 'login.html';
            }
        };
    </script>
</body>
</html>