<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Login | Cryptware</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script type="module" src="./js/config.js"></script>
    <script type="module" src="./js/supabase-client.js"></script>
    <script type="module" src="./js/utils/toast.js"></script>
    <script type="module" src="./js/auth-manager.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
        }

        .trust-badge {
            background: var(--primary-gradient);
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .input-error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
        }

        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-up {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-blue-950 min-h-screen flex items-center justify-center p-4 font-['Inter']">
    <div class="w-full max-w-md">
        <!-- Logo & Trust Badge -->
        <div class="text-center mb-8 slide-up">
            <div class="trust-badge inline-flex items-center px-4 py-2 rounded-full mb-4">
                <i class="fas fa-shield-alt text-white mr-2"></i>
                <span class="text-white text-sm font-medium">Enterprise Secure</span>
            </div>
            <h1 class="text-3xl font-bold text-white mb-2">Cryptware</h1>
            <p class="text-blue-200 text-sm uppercase tracking-widest">Partner Portal</p>
        </div>

        <!-- Unified Login Card -->
        <div class="glass-card rounded-2xl shadow-2xl overflow-hidden fade-in">
            <!-- Card Header -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 text-center">
                <h2 class="text-xl font-bold text-white">Welcome Back</h2>
                <p class="text-blue-100 text-sm">Sign in to your account</p>
            </div>

            <!-- Unified Login Form -->
            <form id="loginForm" class="p-6 md:p-8">
                <div class="mb-5">
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-envelope text-blue-500 mr-2"></i>Email Address
                    </label>
                    <input type="email" id="email" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                           placeholder="Enter your email address"
                           autocomplete="email">
                    <div id="emailError" class="error-message hidden"></div>
                </div>

                <div class="mb-4">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-key text-blue-500 mr-2"></i>Password
                    </label>
                    <input type="password" id="password" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                           placeholder="Enter your password"
                           autocomplete="current-password">
                    <div id="passwordError" class="error-message hidden"></div>
                </div>

                <!-- Forgot Password Link -->
                <div class="mb-6 text-right">
                    <button type="button" onclick="openForgotPassword()" class="text-blue-600 hover:text-blue-700 text-sm font-medium transition-colors">
                        <i class="fas fa-key mr-1"></i>Forgot your password?
                    </button>
                </div>

                <!-- Login Button -->
                <button type="submit" id="loginSubmitBtn"
                        class="w-full trust-badge text-white font-semibold py-3 px-4 rounded-lg transition-all duration-300 shadow-md hover:shadow-lg transform hover:scale-[1.02] flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                    <i class="fas fa-sign-in-alt mr-2"></i> 
                    <span class="btn-text">Sign In</span>
                    <div class="loading-spinner hidden ml-2">
                        <i class="fas fa-spinner"></i>
                    </div>
                </button>

                <!-- Registration Link -->
                <div class="mt-6 text-center">
                    <p class="text-sm text-gray-600">
                        Don't have a partner account? 
                        <a href="partner-signup.html" class="text-blue-600 hover:text-blue-700 font-medium transition-colors duration-200">
                            <i class="fas fa-user-plus mr-1"></i>Apply Now
                        </a>
                    </p>
                </div>
            </form>
        </div>

    </div>

    <!-- Forgot Password Modal -->
    <div id="forgotPasswordModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full transform transition-all duration-300 scale-95 opacity-0">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">Reset Your Password</h3>
                <button onclick="closeForgotPassword()" class="text-gray-500 hover:text-gray-700 transition-colors">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            
            <p class="text-gray-600 mb-4">Enter your email address and we'll send you instructions to reset your password.</p>
            
            <form id="forgotPasswordForm">
                <div class="mb-4">
                    <label for="resetEmail" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-envelope text-blue-500 mr-1"></i>Email Address
                    </label>
                    <input type="email" id="resetEmail" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                           placeholder="your@company.com"
                           autocomplete="email">
                    <div id="resetEmailError" class="error-message hidden"></div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeForgotPassword()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium transition-colors">
                        Cancel
                    </button>
                    <button type="submit" id="resetSubmitBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-300 flex items-center disabled:opacity-50">
                        <i class="fas fa-paper-plane mr-2"></i>
                        <span class="btn-text">Send Reset Link</span>
                        <div class="loading-spinner hidden ml-2">
                            <i class="fas fa-spinner"></i>
                        </div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // DOM Elements
        const loginForm = document.getElementById('loginForm');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginSubmitBtn = document.getElementById('loginSubmitBtn');
    
        // Utility Functions
        function clearErrors() {
            document.querySelectorAll('.error-message').forEach(el => {
                el.classList.add('hidden');
                el.textContent = '';
            });
            document.querySelectorAll('input').forEach(input => {
                input.classList.remove('input-error');
            });
        }
    
        function showError(fieldId, message) {
            const input = document.getElementById(fieldId);
            const errorDiv = document.getElementById(fieldId + 'Error');
            
            if (input && errorDiv) {
                input.classList.add('input-error');
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
                input.focus();
            }
        }
    
        function setLoading(button, isLoading, loadingText = 'Signing in...') {
            const btnText = button.querySelector('.btn-text');
            const spinner = button.querySelector('.loading-spinner');
            
            if (isLoading) {
                button.disabled = true;
                btnText.textContent = loadingText;
                spinner.classList.remove('hidden');
            } else {
                button.disabled = false;
                btnText.textContent = 'Sign In';
                spinner.classList.add('hidden');
            }
        }
    
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
    
        // Enhanced API Client with better error handling
        const apiClient = axios.create({
            baseURL: 'http://localhost:8000/api',
            timeout: 10000,
            headers: {
                'Content-Type': 'application/json'
            }
        });
    
        // Unified Login Handler - PRODUCTION READY
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearErrors();
            
            const email = emailInput.value.trim();
            const password = passwordInput.value;
    
            // Validation
            if (!email) {
                showError('email', 'Email is required');
                return;
            }
            
            if (!password) {
                showError('password', 'Password is required');
                return;
            }
    
            if (!isValidEmail(email)) {
                showError('email', 'Please enter a valid email address');
                return;
            }
    
            setLoading(loginSubmitBtn, true);
    
            try {
                console.log('🔐 Attempting unified login for:', email);
                
                const response = await apiClient.post('/auth/login', {
                    email: email,
                    password: password
                });
    
                console.log('✅ Login response:', response.data);
    
                if (response.data.success) {
                    const { user, userType, session } = response.data.data;
                    
                    // Store user data based on type
                    if (userType === 'partner') {
                        localStorage.setItem('currentPartner', JSON.stringify(user));
                        if (session?.access_token) {
                            localStorage.setItem('authToken', session.access_token);
                        }
                        Toast.success(`Welcome back, ${user.company_name}!`);
                        
                        setTimeout(() => {
                            window.location.href = 'partner-dashboard.html';
                        }, 1000);
                        
                    } else if (userType === 'internal') {
                        localStorage.setItem('internalUser', JSON.stringify(user));
                        if (session?.access_token) {
                            localStorage.setItem('authToken', session.access_token);
                        }
                        Toast.success(`Welcome back, ${user.name}!`);
                        
                        setTimeout(() => {
                            window.location.href = 'internal-dashboard.html';
                        }, 1000);
                    }
                    
                } else {
                    throw new Error(response.data.message || 'Login failed');
                }
                
            } catch (error) {
                console.error('💥 Login error:', error);
                
                let errorMessage = 'Login failed. Please check your credentials.';
                
                // Handle different error types
                if (error.code === 'ERR_NETWORK') {
                    errorMessage = 'Network error. Please check your connection and ensure the backend server is running.';
                } else if (error.response?.status === 405) {
                    errorMessage = 'Server configuration error. Please contact support.';
                } else if (error.response?.status === 404) {
                    errorMessage = 'Login endpoint not found. Please contact support.';
                } else if (error.response?.data?.message) {
                    errorMessage = error.response.data.message;
                } else if (error.message) {
                    errorMessage = error.message;
                }
    
                Toast.error(errorMessage);
                
                // Show specific field errors
                if (errorMessage.toLowerCase().includes('email')) {
                    showError('email', errorMessage);
                } else if (errorMessage.toLowerCase().includes('password')) {
                    showError('password', errorMessage);
                } else if (errorMessage.toLowerCase().includes('network')) {
                    // Network errors don't belong to specific fields
                    showError('email', 'Server connection failed');
                }
            } finally {
                setLoading(loginSubmitBtn, false);
            }
        });
    
        // Forgot Password Functions
        window.openForgotPassword = function() {
            const modal = document.getElementById('forgotPasswordModal');
            const form = modal.querySelector('.bg-white');
            
            // Pre-fill email from login form
            if (emailInput.value) {
                document.getElementById('resetEmail').value = emailInput.value;
            }
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                form.classList.remove('scale-95', 'opacity-0');
                form.classList.add('scale-100', 'opacity-100');
            }, 10);
        };
    
        window.closeForgotPassword = function() {
            const modal = document.getElementById('forgotPasswordModal');
            const form = modal.querySelector('.bg-white');
            
            form.classList.remove('scale-100', 'opacity-100');
            form.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                document.getElementById('forgotPasswordForm').reset();
                document.getElementById('resetEmailError').classList.add('hidden');
            }, 300);
        };
    
        // Forgot Password Form Submission
        document.getElementById('forgotPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearErrors();
            
            const email = document.getElementById('resetEmail').value.trim();
            const submitBtn = document.getElementById('resetSubmitBtn');
            
            if (!email) {
                showError('resetEmail', 'Email is required');
                return;
            }
    
            if (!isValidEmail(email)) {
                showError('resetEmail', 'Please enter a valid email address');
                return;
            }
    
            setLoading(submitBtn, true, 'Sending...');
    
            try {
                const response = await apiClient.post('/auth/forgot-password', {
                    email: email
                });
    
                if (response.data.success) {
                    Toast.success('📧 Check your email for reset instructions');
                    window.closeForgotPassword();
                } else {
                    throw new Error(response.data.message || 'Failed to send reset email');
                }
            } catch (error) {
                console.error('Forgot password error:', error);
                const errorMessage = error.response?.data?.message || error.message || 'Failed to send reset instructions';
                Toast.error(errorMessage);
            } finally {
                setLoading(submitBtn, false);
            }
        });
    
        // Auto-redirect if already logged in
        document.addEventListener('DOMContentLoaded', async () => {
            // Check for existing sessions
            const partner = localStorage.getItem('currentPartner');
            const internalUser = localStorage.getItem('internalUser');
            
            if (partner) {
                window.location.href = 'partner-dashboard.html';
                return;
            }
            
            if (internalUser) {
                window.location.href = 'internal-dashboard.html';
                return;
            }
    
            // Show demo helper in development
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                document.getElementById('demoHelper').classList.remove('hidden');
            }
    
            // Check for URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const verified = urlParams.get('verified');
            
            if (verified) {
                Toast.success('🎉 Email verified successfully! You can now login.');
            }
    
            // Auto-focus email field
            emailInput.focus();
        });
    
        // Modal close handlers
        document.getElementById('forgotPasswordModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeForgotPassword();
            }
        });
    
        // Enter key support
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const activeModal = document.getElementById('forgotPasswordModal');
                if (!activeModal.classList.contains('hidden')) {
                    const submitBtn = activeModal.querySelector('button[type="submit"]');
                    if (submitBtn && !submitBtn.disabled) {
                        submitBtn.click();
                    }
                } else {
                    if (loginSubmitBtn && !loginSubmitBtn.disabled) {
                        loginSubmitBtn.click();
                    }
                }
            }
        });
    
        // Enhanced input interactions
        emailInput.addEventListener('input', () => {
            emailInput.classList.remove('input-error');
            document.getElementById('emailError').classList.add('hidden');
        });
    
        passwordInput.addEventListener('input', () => {
            passwordInput.classList.remove('input-error');
            document.getElementById('passwordError').classList.add('hidden');
        });
    
        // Network status monitoring
        window.addEventListener('online', () => {
            console.log('🌐 Network connection restored');
        });
    
        window.addEventListener('offline', () => {
            Toast.error('📡 Network connection lost');
        });
    </script>
</body>
</html>